<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oris - Debug Mode (2 min)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" href="data:,">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --accent: #9c27b0; --glow: #ce93d8; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #000; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0; pointer-events: none; transition: opacity 2s ease; background: #000; }
        
        #ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; pointer-events: none;
            transition: opacity 0.8s ease;
        }

        #start-btn {
            pointer-events: auto; padding: 22px 60px; cursor: pointer;
            background: var(--accent); color: white; border: none; border-radius: 50px;
            font-size: 1.4rem; font-weight: bold; box-shadow: 0 0 30px rgba(156, 39, 176, 0.6);
            transition: all 0.5s ease;
        }

        #energy-field {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 0; height: 0; border-radius: 50%; z-index: 10;
            background: radial-gradient(circle, rgba(156, 39, 176, 1) 0%, rgba(156, 39, 176, 0.4) 80%, transparent 100%);
            opacity: 0; transition: width 2s, height 2s, opacity 2s; pointer-events: none;
        }

        #countdown { font-size: 5.5rem; font-weight: bold; text-shadow: 0 0 30px var(--accent); opacity: 0; transition: opacity 1s; }

        #subtitles {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 700px;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; text-align: center;
            font-size: 1.3rem; opacity: 0; transition: opacity 1s; z-index: 1100;
        }

        /* ESTADOS */
        .waiting-mode #start-btn, .waiting-mode #online-count { display: none; }
        .waiting-mode #countdown, .waiting-mode #energy-field, .waiting-mode #subtitles { opacity: 1; }
        .waiting-mode #energy-field { width: 320px; height: 320px; }

        .playing-mode #ui-overlay { opacity: 0; visibility: hidden; } 
        .playing-mode #map { opacity: 1; pointer-events: auto; }
        .playing-mode #subtitles { opacity: 1; }
        .playing-mode #energy-field { width: 150px; height: 150px; opacity: 0.6; }
    </style>
</head>

<body>
    <div id="map"></div>
    
    <div id="ui-overlay">
        <div id="online-count" style="margin-bottom: 20px; color: var(--glow); letter-spacing: 2px;">SINCRONIA ESTABELECIDA</div>
        <button id="start-btn">ENTRAR NA CORRENTE</button>
        <div id="countdown">02:00</div>
    </div>

    <div id="energy-field"></div>
    <div id="subtitles"></div>

    <script>
        let audioCtx, masterGain, oscillator;
        
        // CORREÇÃO: Definindo 'agora' antes de usar para evitar erro de script
        const agoraPre = new Date();
        let segRestantes_ORI = (15 - (agoraPre.getMinutes() % 15)) * 60 - agoraPre.getSeconds();
        
        // Mantenha 120 para o debug de 2 minutos funcionar
        let segRestantes = 10; 
        let prontoParaIniciar = false;
        let legendasTimeout;
        let userCoords = [0, 0];

        const map = L.map('map', { center: [0, 0], zoom: 2, zoomControl: false, attributionControl: false });
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);

        function start432Hz() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(432, audioCtx.currentTime);
            oscillator.connect(masterGain);
            masterGain.connect(audioCtx.destination);
            masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
            masterGain.gain.linearRampToValueAtTime(0.02, audioCtx.currentTime + 3); 
            oscillator.start();
        }

        function stop432Hz() {
            if (masterGain) {
                masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 2);
                setTimeout(() => { if(oscillator) { oscillator.stop(); oscillator = null; } }, 2000);
            }
        }

        const scriptsEspera = [
            "Limpando o teu campo vibracional com a frequência de cura...",
            "Elevando o teu campo áurico para uma oração potente...",
            "Dissolvendo bloqueios e purificando as tuas intenções...",
            "Conectando a tua alma à rede de luz planetária...",
            "Prepara-te para o silêncio sagrado..."
        ];

        function sincronizarLegendas(segundos) {
            const tempoUtil = segundos - 5; 
            const tempoPorLegenda = (tempoUtil / scriptsEspera.length) * 1000;
            let i = 0;
            const proxima = () => {
                if (i < scriptsEspera.length && prontoParaIniciar) {
                    document.getElementById('subtitles').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('subtitles').innerText = scriptsEspera[i];
                        document.getElementById('subtitles').style.opacity = 1;
                        i++;
                        legendasTimeout = setTimeout(proxima, tempoPorLegenda);
                    }, 1000);
                }
            };
            proxima();
        }

        document.getElementById('start-btn').addEventListener('click', function() {
            start432Hz();
            document.body.className = 'waiting-mode';
            prontoParaIniciar = true;
            sincronizarLegendas(segRestantes);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userCoords = [position.coords.latitude, position.coords.longitude];
                }, () => {
                    userCoords = [-23.55, -46.63]; 
                });
            }
        });

        setInterval(() => {
            if (!prontoParaIniciar) return;

            segRestantes--;
            const m = Math.floor(segRestantes / 60);
            const s = segRestantes % 60;
            document.getElementById('countdown').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            if (segRestantes === 5) {
                stop432Hz();
                document.getElementById('subtitles').style.opacity = 0;
            }

            if (segRestantes <= 0) {
                prontoParaIniciar = false;
                document.body.className = 'playing-mode';
                setTimeout(() => {
                    map.invalidateSize();
                    document.getElementById('subtitles').innerText = "Iniciando Mentalização Planetária...";
                    document.getElementById('subtitles').style.opacity = 1;
                    map.flyTo(userCoords, 18, { duration: 6 });
                }, 100);
            }
        }, 1000);
    </script>
</body>
</html>